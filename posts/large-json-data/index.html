<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="rgb(255,255,255)"><title>Send Large JSON Data to IoT Hub Using MQTT &#183; Silvio</title>
<meta name=title content="Send Large JSON Data to IoT Hub Using MQTT &#183; Silvio"><script type=text/javascript src=/js/appearance.min.022d0ebc3b46a335eb1c7ef79b7f2de143d7cd5156d433638592ef1ce5f8554e.js integrity="sha256-Ai0OvDtGozXrHH73m38t4UPXzVFW1DNjhZLvHOX4VU4="></script><link type=text/css rel=stylesheet href=/css/main.bundle.min.32d04888ee333fe8a86a4c077eeea1611eeaad40f0a347801852445d69ed4f6b.css integrity="sha256-MtBIiO4zP+ioakwHfu6hYR7qrUDwo0eAGFJEXWntT2s="><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.d4b727caf411cb5c3b421d0d427ed1e3daeafe0d04840327efad4978430edb8c.js integrity="sha256-1LcnyvQRy1w7Qh0NQn7R49rq/g0EhAMn761JeEMO24w=" data-copy=Copy data-copied=Copied></script><meta name=description content="
      
        How to program an Arduino 33 IoT board to communicate with Microsoft Azure, through IoT Hub and Stream Analytics. In particular, I explain a workaround to send JSON files bigger than 256 B.
      
    "><link rel=canonical href=https://example.org/posts/large-json-data/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Send Large JSON Data to IoT Hub Using MQTT"><meta property="og:description" content="How to program an Arduino 33 IoT board to communicate with Microsoft Azure, through IoT Hub and Stream Analytics. In particular, I explain a workaround to send JSON files bigger than 256 B."><meta property="og:type" content="article"><meta property="og:url" content="https://example.org/posts/large-json-data/"><meta property="og:image" content="https://example.org/posts/large-json-data/featured.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-08-24T09:31:28+00:00"><meta property="article:modified_time" content="2020-08-24T09:31:28+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://example.org/posts/large-json-data/featured.png"><meta name=twitter:title content="Send Large JSON Data to IoT Hub Using MQTT"><meta name=twitter:description content="How to program an Arduino 33 IoT board to communicate with Microsoft Azure, through IoT Hub and Stream Analytics. In particular, I explain a workaround to send JSON files bigger than 256 B."><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Send Large JSON Data to IoT Hub Using MQTT","headline":"Send Large JSON Data to IoT Hub Using MQTT","abstract":"How to program an Arduino 33 IoT board to communicate with Microsoft Azure, through IoT Hub and Stream Analytics. In particular, I explain a workaround to send JSON files bigger than 256 B.","inLanguage":"en","url":"https:\/\/example.org\/posts\/large-json-data\/","author":{"@type":"Person","name":""},"copyrightYear":"2020","dateCreated":"2020-08-24T09:31:28\u002b00:00","datePublished":"2020-08-24T09:31:28\u002b00:00","dateModified":"2020-08-24T09:31:28\u002b00:00","keywords":["Programming","IoT"],"mainEntityOfPage":"true","wordCount":"1027"}</script></head><body class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral"><div id=the-top class="absolute flex self-center"><a class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold text-neutral-900 print:hidden sm:py-10 dark:text-neutral"><nav class="flex items-start justify-between sm:items-center"><div class="z-40 flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Silvio</a></div><label id=menu-button for=menu-controller class="block sm:hidden"><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="invisible fixed inset-0 z-30 m-auto h-full w-full cursor-default overflow-auto bg-neutral-100/50 opacity-0 backdrop-blur-sm transition-opacity dark:bg-neutral-900/50"><ul class="mx-auto flex w-full max-w-7xl list-none flex-col overflow-visible px-6 py-6 text-end sm:px-14 sm:py-10 sm:pt-10 md:px-24 lg:px-32"><li class=mb-1><span class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class="group mb-1"><a href=/posts/ title onclick=close_menu()><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Blog</span></a></li><li class="group mb-1"><a href title onclick=close_menu()><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Author</span></a></li><li class="group mb-1"><a href=/now/ title onclick=close_menu()><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Now</span></a></li><li class="group mb-1"></li></ul></div></label><ul class="hidden list-none flex-row text-end sm:flex"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><a href=/posts/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Blog</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><a href title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Author</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><a href=/now/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Now</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"></li></ul></nav></header><div class="relative flex grow flex-col"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 print:hidden dark:text-neutral-400"><li class="hidden inline"><a class="dark:underline-neutral-600 decoration-neutral-300 hover:underline" href=/>Silvio</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="dark:underline-neutral-600 decoration-neutral-300 hover:underline" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class="hidden inline"><a class="dark:underline-neutral-600 decoration-neutral-300 hover:underline" href=/posts/large-json-data/>Send Large JSON Data to IoT Hub Using MQTT</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Send Large JSON Data to IoT Hub Using MQTT</h1><div class="mb-12 mt-8 text-base text-neutral-500 print:hidden dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime="2020-08-24 09:31:28 +0000 UTC">24 August 2020</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">5 mins</span></div></div><div class=prose><picture class="mb-6 -mt-4 rounded-md"><source srcset="/posts/large-json-data/featured_hu0d2bbb477f78d1479173add60247073f_41358_330x0_resize_q75_h2_box_3.webp 330w,/posts/large-json-data/featured_hu0d2bbb477f78d1479173add60247073f_41358_660x0_resize_q75_h2_box_3.webp 660w
,/posts/large-json-data/featured_hu0d2bbb477f78d1479173add60247073f_41358_1024x0_resize_q75_h2_box_3.webp 1024w
,/posts/large-json-data/featured_hu0d2bbb477f78d1479173add60247073f_41358_1100x550_resize_q75_h2_box_3.webp 1100w" sizes=100vw type=image/webp><img width=1100 height=550 class="mb-6 -mt-4 rounded-md" src=/posts/large-json-data/featured_hu0d2bbb477f78d1479173add60247073f_41358_660x0_resize_box_3.png srcset="/posts/large-json-data/featured_hu0d2bbb477f78d1479173add60247073f_41358_330x0_resize_box_3.png 330w,/posts/large-json-data/featured_hu0d2bbb477f78d1479173add60247073f_41358_660x0_resize_box_3.png 660w
,/posts/large-json-data/featured_hu0d2bbb477f78d1479173add60247073f_41358_1024x0_resize_box_3.png 1024w
,/posts/large-json-data/featured.png 1100w" sizes=100vw></picture></div></header><section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8"><div class="toc pe-5 print:hidden lg:sticky lg:top-10"><details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5"><summary class="-ms-5 block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 lg:hidden dark:bg-neutral-700 dark:text-neutral-100">Table of Contents</summary><div class="-ms-5 border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#implementation>Implementation</a></li></ul></nav></div></details></div></div><div class="min-h-0 min-w-0 max-w-prose grow"><p>This article is to demonstrate how to program an Arduino Nano 33 IoT board to communicate with Microsoft Azure. With a quick Google search, you would find out that there&rsquo;s already a library with all the functions required to share messages between Azure and Arduino boards. It is called
<a href=https://github.com/Azure/azure-iot-arduino target=_blank rel=noreferrer>AzureIoTHub</a> and is the IoT Hub&rsquo;s official Arduino library, published by Azure as a port of the
<a href=https://github.com/Azure/azure-iot-sdk-c target=_blank rel=noreferrer>Microsoft Azure IoT device SDK for C</a>). The problem is that it doesn&rsquo;t actually support any Arduino board. Looking at the <code>README.md</code> file, the hardware currently supported is:</p><ul><li><p>ESP8266 based boards with
<a href=https://github.com/esp8266/arduino target=_blank rel=noreferrer>esp8266/arduino</a></p><ul><li><p>SparkFun
<a href=https://www.sparkfun.com/products/13711 target=_blank rel=noreferrer>Thing</a></p></li><li><p>Adafruit
<a href=https://www.adafruit.com/products/2821 target=_blank rel=noreferrer>Feather Huzzah</a></p></li></ul></li><li><p>ESP32 based boards with
<a href=https://github.com/espressif/arduino-esp32 target=_blank rel=noreferrer>espressif/arduino-esp32</a></p><ul><li>Adafruit
<a href=https://www.adafruit.com/product/3405 target=_blank rel=noreferrer>HUZZAH32</a></li></ul></li></ul><p>So, until the next compatibility update, the only way to send telemetry from a Nano 33 IoT to Azure IoT Hub is through third-party libraries.</p><h2 id=prerequisites class="relative group">Prerequisites <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#prerequisites aria-label=Anchor>#</a></span></h2><p>To code my workaround, I used the following libraries:</p><ul><li><p><a href=https://arduinojson.org target=_blank rel=noreferrer>ArduinoJson</a> - To encapsulate my data in a JSON message, one of the formats accepted by IoT Hub;</p></li><li><p><a href=https://github.com/arduino-libraries/WiFiNINA target=_blank rel=noreferrer>WiFiNINA</a> - To connect the board to the WiFi;</p></li><li><p><a href=https://github.com/arduino-libraries/ArduinoMqttClient target=_blank rel=noreferrer>ArduinoMqttClient</a> - Client that allows to send and receive MQTT messages;</p></li><li><p><a href=https://github.com/arduino-libraries/ArduinoBearSSL target=_blank rel=noreferrer>ArduinoBearSSL</a> - Port of
<a href=https://bearssl.org/ target=_blank rel=noreferrer>BearSSL</a> to Arduino, to implement the SSL/TLS protocol;</p></li><li><p><a href=https://github.com/arduino-libraries/ArduinoECCX08 target=_blank rel=noreferrer>ArduinoECCX08</a> - Library for the Atmel/Microchip ECC508 and ECC608 crypto chips, used for authentication with IoT Hub with a SelfSigned X.509 certificate;</p></li></ul><p>All libraries must be installed on your system before compiling the code (instructions on how to install Arduino libraries can be found
<a href=https://www.arduino.cc/en/guide/libraries target=_blank rel=noreferrer>here</a>).</p><h2 id=implementation class="relative group">Implementation <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#implementation aria-label=Anchor>#</a></span></h2><p>Unfortunately, it&rsquo;s not that easy. Turns out that in the first version of my code, I could successfully send short messages over <code>Serial</code> and <code>MQTT</code>. But, when I tried to send a JSON text bigger than 256 Bytes (i.e. longer than 256 characters), it arrived at the Hub truncated.</p><figure><img src=/post/large-json-data/monitor-events-NOT-WORKING.png alt><figcaption class=text-center>Screenshot of the Azure Cloud Shell when receiving a truncated message.</figcaption></figure><p>A similar issue is documented
<a href=https://github.com/firedog1024/mkr1000-iotc target=_blank rel=noreferrer>here</a>, using a different library for the MQTT client. In that case, the advised solution is to change the value <code>ENTER VALUE TO CHANGE</code> from <code>256</code> to <code>2048</code>, but that implies the following things:</p><ul><li>you&rsquo;d have to edit the library source code, so your program is not reproducible on other systems;</li><li>you still set a fixed value, which, even if bigger, it&rsquo;s not scalable.</li></ul><figure><img src=/post/large-json-data/monitor-events-NOT-WORKING.png alt><figcaption class=text-center>Azure Cloud Shell when the hub is receiving the correct message.</figcaption></figure><p>Instead, the solution explained here doesn&rsquo;t require any modification of the libraries&rsquo; source code, since all the changes are made inside the sketch. Concretely, in the <code>publishMessage()</code> function, we declare the char array named <code>payload</code>, which acts as a temporary buffer to store the JSON document. Then, using <code>serializeJson()</code>, the document is serialized to the buffer and the function returns the number of bytes written, which is stored in <code>payloadSize</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>char</span> <span class=n>payload</span><span class=p>[</span><span class=mi>1024</span><span class=p>];</span> <span class=c1>// length of the char buffer that contains the JSON file, concretely the number of characters included in one message
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>size_t</span> <span class=n>payloadSize</span> <span class=o>=</span> <span class=n>serializeJson</span><span class=p>(</span><span class=n>doc</span><span class=p>,</span> <span class=n>payload</span><span class=p>);</span>
</span></span></code></pre></div><p>Now that we have the message and its size, we can send it via MQTT protocol to the IoT Hub. Through the overloaded function <code>beginMessage()</code> we pass the topic and the message size. Then, using the <code>Print</code> class implemented in ArduinoMqttClient, the JSON document is passed directly in the message body. Finally, the <code>endMessage()</code> function publishes the document to the specified topic.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// send message, the Print interface can be used to set the message contents
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mqttClient</span><span class=p>.</span><span class=n>beginMessage</span><span class=p>(</span><span class=s>&#34;devices/&#34;</span> <span class=o>+</span> <span class=n>deviceId</span> <span class=o>+</span> <span class=s>&#34;/messages/events/&#34;</span><span class=p>,</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=o>&gt;</span><span class=p>(</span><span class=n>payloadSize</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=n>mqttClient</span><span class=p>.</span><span class=n>print</span><span class=p>(</span><span class=n>payload</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>mqttClient</span><span class=p>.</span><span class=n>endMessage</span><span class=p>();</span>
</span></span></code></pre></div><p>The complete function, as found in the example code, is the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>publishMessage</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Serial</span><span class=p>.</span><span class=n>println</span><span class=p>(</span><span class=s>&#34;Publishing message&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>int</span> <span class=n>capacity</span> <span class=o>=</span> <span class=n>JSON_ARRAY_SIZE</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span> <span class=o>+</span> <span class=mi>10</span><span class=o>*</span><span class=n>JSON_OBJECT_SIZE</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=o>+</span> <span class=n>JSON_OBJECT_SIZE</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span> <span class=o>+</span> <span class=mi>280</span><span class=p>;</span>     <span class=c1>// Calculation of the JSON doc size, as explained in the documentation
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/*  
</span></span></span><span class=line><span class=cl><span class=cm>Here is where you should write the body of your message. In this example, the JSON doc is purposely longer than 256 characters, to highlight the issue.
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>StaticJsonDocument</span><span class=o>&lt;</span><span class=n>capacity</span><span class=o>&gt;</span> <span class=n>doc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>doc</span><span class=p>[</span><span class=s>&#34;topic&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;messageTopic&#34;</span><span class=p>;</span>  
</span></span><span class=line><span class=cl>  <span class=n>doc</span><span class=p>[</span><span class=s>&#34;deviceId&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>deviceId</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>JsonArray</span> <span class=n>data</span> <span class=o>=</span> <span class=n>doc</span><span class=p>.</span><span class=n>createNestedArray</span><span class=p>(</span><span class=s>&#34;data&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>JsonObject</span> <span class=n>data_0</span> <span class=o>=</span> <span class=n>data</span><span class=p>.</span><span class=n>createNestedObject</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>data_0</span><span class=p>[</span><span class=s>&#34;label&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;Ankara&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>data_0</span><span class=p>[</span><span class=s>&#34;state&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>JsonObject</span> <span class=n>data_1</span> <span class=o>=</span> <span class=n>data</span><span class=p>.</span><span class=n>createNestedObject</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>data_1</span><span class=p>[</span><span class=s>&#34;label&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;Beirut&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>data_1</span><span class=p>[</span><span class=s>&#34;state&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>JsonObject</span> <span class=n>data_2</span> <span class=o>=</span> <span class=n>data</span><span class=p>.</span><span class=n>createNestedObject</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>data_2</span><span class=p>[</span><span class=s>&#34;label&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;Cincinnati&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>data_2</span><span class=p>[</span><span class=s>&#34;state&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>JsonObject</span> <span class=n>data_3</span> <span class=o>=</span> <span class=n>data</span><span class=p>.</span><span class=n>createNestedObject</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>data_3</span><span class=p>[</span><span class=s>&#34;label&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;Detroit&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>data_3</span><span class=p>[</span><span class=s>&#34;state&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>JsonObject</span> <span class=n>data_4</span> <span class=o>=</span> <span class=n>data</span><span class=p>.</span><span class=n>createNestedObject</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>data_4</span><span class=p>[</span><span class=s>&#34;label&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;Eindhoven&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>data_4</span><span class=p>[</span><span class=s>&#34;state&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>JsonObject</span> <span class=n>data_5</span> <span class=o>=</span> <span class=n>data</span><span class=p>.</span><span class=n>createNestedObject</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>data_5</span><span class=p>[</span><span class=s>&#34;label&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;Fresno&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>data_5</span><span class=p>[</span><span class=s>&#34;state&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>JsonObject</span> <span class=n>data_6</span> <span class=o>=</span> <span class=n>data</span><span class=p>.</span><span class=n>createNestedObject</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>data_6</span><span class=p>[</span><span class=s>&#34;label&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;Genoa&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>data_6</span><span class=p>[</span><span class=s>&#34;state&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>JsonObject</span> <span class=n>data_7</span> <span class=o>=</span> <span class=n>data</span><span class=p>.</span><span class=n>createNestedObject</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>data_7</span><span class=p>[</span><span class=s>&#34;label&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;Huddersfield&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>data_7</span><span class=p>[</span><span class=s>&#34;state&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>JsonObject</span> <span class=n>data_8</span> <span class=o>=</span> <span class=n>data</span><span class=p>.</span><span class=n>createNestedObject</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>data_8</span><span class=p>[</span><span class=s>&#34;label&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;Istanbul&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>data_8</span><span class=p>[</span><span class=s>&#34;state&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>JsonObject</span> <span class=n>data_9</span> <span class=o>=</span> <span class=n>data</span><span class=p>.</span><span class=n>createNestedObject</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>data_9</span><span class=p>[</span><span class=s>&#34;label&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;Jakarta&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>data_9</span><span class=p>[</span><span class=s>&#34;state&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//   DEBUG - serialize the document in the serial monitor
</span></span></span><span class=line><span class=cl><span class=c1>//   serializeJson(doc, Serial);
</span></span></span><span class=line><span class=cl><span class=c1>//   Serial.println(&#34; &#34;);
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>payload</span><span class=p>[</span><span class=mi>1024</span><span class=p>];</span> <span class=c1>// length of the char buffer that contains the JSON file, concretely the number of characters included in one message
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>size_t</span> <span class=n>payloadSize</span> <span class=o>=</span> <span class=n>serializeJson</span><span class=p>(</span><span class=n>doc</span><span class=p>,</span> <span class=n>payload</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//   DEBUG - write the size of the serialized document
</span></span></span><span class=line><span class=cl><span class=c1>//   Serial.print(&#34;json size:&#34;);
</span></span></span><span class=line><span class=cl><span class=c1>//   Serial.println(payloadSize);
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl><span class=c1>// send message, the Print interface can be used to set the message contents
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>mqttClient</span><span class=p>.</span><span class=n>beginMessage</span><span class=p>(</span><span class=s>&#34;devices/&#34;</span> <span class=o>+</span> <span class=n>deviceId</span> <span class=o>+</span> <span class=s>&#34;/messages/events/&#34;</span><span class=p>,</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=o>&gt;</span><span class=p>(</span><span class=n>payloadSize</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>mqttClient</span><span class=p>.</span><span class=n>print</span><span class=p>(</span><span class=n>payload</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>mqttClient</span><span class=p>.</span><span class=n>endMessage</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=cm>/*  
</span></span></span><span class=line><span class=cl><span class=cm>To replicate the issue, uncomment the following 3 lines and comment the 3 above. This way you&#39;ll only be able to send MQTT messages smaller than 256 Bytes.
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=c1>//  mqttClient.beginMessage(&#34;devices/&#34; + deviceId + &#34;/messages/events/&#34;);
</span></span></span><span class=line><span class=cl><span class=c1>//  serializeJson(doc, mqttClient);
</span></span></span><span class=line><span class=cl><span class=c1>//  mqttClient.endMessage();
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>The function above creates a JSON document as follows. Obviously, it can be changed as needed, this is an example to highlight the issue, since the text is longer than 256 characters.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;topic&#34;</span><span class=p>:</span> <span class=s2>&#34;messageTopic&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;deviceId&#34;</span><span class=p>:</span> <span class=s2>&#34;deviceId&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;data&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;Ankara&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;state&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;Beirut&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;state&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;Cincinnati&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;state&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;Detroit&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;state&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;Eindhoven&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;state&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;Fresno&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;state&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;Genoa&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;state&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;Huddersfield&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;state&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;Istanbul&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;state&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;Jakarta&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;state&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><hr><p>I hope that this post was helpful. I uploaded an example of the code to send large JSON data from an Arduino Nano 33 IoT to Azure IoT Hub to a
<a href=https://github.com/s-gregorini003/azure-iot-arduino-nano-33-iot.git target=_blank rel=noreferrer>GitHub repository</a>. Follow the instructions in the <code>README.md</code> to configure it properly. Feel free to use it, modify it and extend it as you like. Thanks for reading!</p></div></section><footer class="max-w-prose pt-8 print:hidden"><div class=flex><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/posts/noise-3d-printer/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Noise and Vibration Analysis of 3D Printers</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2020-06-18 08:45:42 +0000 UTC">18 June 2020</time>
</span></span></a></span><span></span></div></div></footer></article><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><nav class="pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex list-none flex-col sm:flex-row"><li class="group mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0"><a href=/tags/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Tags</span></a></li></ul></nav><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">Copy, <em>right?</em> 🤔</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://github.com/jpanther/congo target=_blank rel="noopener noreferrer">Congo</a></p></div><div class="flex flex-row items-center"></div></div></footer></div></body></html>